<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Powerlifting Warmup Timer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-white p-6">
  <div class="max-w-2xl mx-auto">
    <!-- Your existing HTML UI here (unchanged) -->
    <!-- ... -->
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAm9CzwFSHMmUQ7EUhp38OsnlUlLwXu75Q",
      authDomain: "powerliftingwarmuptimer.firebaseapp.com",
      projectId: "powerliftingwarmuptimer",
      storageBucket: "powerliftingwarmuptimer.firebasestorage.app",
      messagingSenderId: "209334487029",
      appId: "1:209334487029:web:8ffb1d4dd6c649e46f42bc",
      measurementId: "G-DHVVDB1SC5"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    const STORAGE_PREFIX = 'pl_timer_';

    let state = {
      sessionId: null,
      flightStartTime: '',
      liftersBeforeYou: 5,
      totalLifters: 12,
      openerWeight: '',
      timeFormat: '24h',
      warmups: [
        { weight: '', reps: 1, minutesBefore: 5, completed: false, targetTime: null, actualTime: null },
        { weight: '', reps: 1, minutesBefore: 5, completed: false, targetTime: null, actualTime: null },
        { weight: '', reps: 1, minutesBefore: 5, completed: false, targetTime: null, actualTime: null }
      ],
      isRunning: false,
      currentWarmupIndex: 0,
      activeWarmups: [],
      showFlightTimeEdit: false
    };

    let currentTime = Date.now();
    let draggedIndex = null;
    let isViewOnly = false;

    // Check if this is a view-only link
    function checkViewOnlyMode() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('view');
      
      if (sessionId) {
        isViewOnly = true;
        state.sessionId = sessionId;
        loadSharedSessionFirebase();
        document.getElementById('setupView').style.display = 'none';
        document.getElementById('timerView').style.display = 'none';
        document.getElementById('viewOnlyMode').style.display = 'block';
      }
    }

    // Generate unique session ID
    function generateSessionId() {
      return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Save session state to Firebase Realtime Database
    async function saveSharedSession() {
      if (!state.sessionId) {
        state.sessionId = generateSessionId();
      }
      const sessionRef = ref(db, 'sessions/' + state.sessionId);

      // Prepare data to store
      const sessionData = {
        flightStartTime: state.flightStartTime,
        liftersBeforeYou: state.liftersBeforeYou,
        openerWeight: state.openerWeight,
        timeFormat: state.timeFormat,
        activeWarmups: state.activeWarmups.map(w => ({
          weight: w.weight,
          reps: w.reps,
          minutesBefore: w.minutesBefore,
          completed: w.completed,
          targetTime: w.targetTime ? w.targetTime.getTime() : null,
          actualTime: w.actualTime ? w.actualTime.getTime() : null,
        })),
        currentWarmupIndex: state.currentWarmupIndex,
        lastUpdated: Date.now()
      };

      try {
        await set(sessionRef, sessionData);
        updateShareLink();
      } catch (error) {
        console.error('Error saving session to Firebase:', error);
      }
    }

    // Load session state from Firebase and listen for live updates
    function loadSharedSessionFirebase() {
      const sessionRef = ref(db, 'sessions/' + state.sessionId);

      onValue(sessionRef, (snapshot) => {
        if (snapshot.exists()) {
          const sessionData = snapshot.val();
          state.flightStartTime = sessionData.flightStartTime;
          state.liftersBeforeYou = sessionData.liftersBeforeYou;
          state.openerWeight = sessionData.openerWeight;
          state.timeFormat = sessionData.timeFormat;
          state.currentWarmupIndex = sessionData.currentWarmupIndex;
          state.activeWarmups = sessionData.activeWarmups.map(w => ({
            ...w,
            targetTime: w.targetTime ? new Date(w.targetTime) : null,
            actualTime: w.actualTime ? new Date(w.actualTime) : null
          }));

          if (isViewOnly) {
            updateViewOnlyDisplay();
          } else {
            updateTimerView();
          }
        } else {
          console.warn('No session data found for:', state.sessionId);
        }
      });
    }

    // Existing updateViewOnlyDisplay(), updateTimerView(), etc.
    // Your existing helper functions stay as-is, except replace
    // any old storage calls with saveSharedSession() and loadSharedSessionFirebase()

    // Replace your interval save with Firebase save call
    setInterval(() => {
      currentTime = Date.now();
      if (state.isRunning && !isViewOnly) {
        updateTimerView();
        saveSharedSession(); // Save state periodically for live updates
      } else if (isViewOnly) {
        updateViewOnlyDisplay();
      }
    }, 1000);

    // The rest of your original script logic stays here...
    // Just replace calls to old storage functions with new Firebase versions.

    // For example, replace:
    // loadSharedSession() -> loadSharedSessionFirebase()
    // saveSharedSession() -> (as above, now uses Firebase)

    // Make sure your startTimer() calls saveSharedSession()
    // so session is saved and shareable.

    // Initialize app
    checkViewOnlyMode();
    if (!isViewOnly) {
      renderWarmups();
      checkCanStart();
    }
  </script>
</body>
</html>
