<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Powerlifting Warmup Timer with Firebase</title>
  <style>
    /* Minimal styling to keep it readable */
    body {
      font-family: system-ui, sans-serif;
      background: #1a202c;
      color: white;
      padding: 1rem;
      max-width: 700px;
      margin: auto;
    }
    input, select, button {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 4px;
      border: none;
      margin-bottom: 1rem;
    }
    input, select {
      width: 100%;
      background: #2d3748;
      color: white;
      border: 1px solid #4a5568;
    }
    button {
      background: #48bb78;
      color: #1a202c;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #718096;
      cursor: not-allowed;
    }
    .warmup {
      background: #2d3748;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      cursor: grab;
    }
    .dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>

<h1>Powerlifting Warmup Timer</h1>

<div id="app">
  <!-- The app UI will be rendered here -->
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAm9CzwFSHMmUQ7EUhp38OsnlUlLwXu75Q",
    authDomain: "powerliftingwarmuptimer.firebaseapp.com",
    databaseURL: "https://powerliftingwarmuptimer-default-rtdb.firebaseio.com/",
    projectId: "powerliftingwarmuptimer",
    storageBucket: "powerliftingwarmuptimer.firebasestorage.app",
    messagingSenderId: "209334487029",
    appId: "1:209334487029:web:8ffb1d4dd6c649e46f42bc",
    measurementId: "G-DHVVDB1SC5"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Utility to get URL param ?view=...
  function getViewSessionId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("view");
  }

  // Timer state variables
  let flightStartTime = "";
  let liftersBeforeYou = 5;
  let openerWeight = "";
  let timeFormat = "24h";
  let numWarmups = 3;
  let warmups = [];
  let isRunning = false;
  let activeWarmups = [];
  let currentWarmupIndex = 0;
  let timerInterval = null;
  let sessionId = "";
  const appDiv = document.getElementById("app");

  // Helpers for time formatting
  function formatTime(date) {
    if (!date) return "--:--";
    const hour12 = timeFormat === "12h";
    return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12 });
  }

  // Calculate target times for warmups
  function calculateTargetTimes(warmupsToCalc) {
    if (!flightStartTime || warmupsToCalc.length === 0) return warmupsToCalc;
    const [hours, minutes] = flightStartTime.split(":").map(Number);
    const flightStart = new Date();
    flightStart.setHours(hours, minutes, 0, 0);
    const openerTime = new Date(flightStart.getTime() + liftersBeforeYou * 60000);
    const result = [...warmupsToCalc];
    let nextTime = openerTime;
    for (let i = result.length - 1; i >= 0; i--) {
      const targetTime = new Date(nextTime.getTime() - result[i].minutesBefore * 60000);
      result[i].targetTime = targetTime;
      nextTime = targetTime;
    }
    return result;
  }

  // Generate a random session ID
  function generateSessionId() {
    return Math.random().toString(36).slice(2, 10);
  }

  // Save current timer state to Firebase
  function saveSession() {
    if (!sessionId) return;
    const sessionRef = ref(db, "sessions/" + sessionId);
    const saveData = {
      flightStartTime,
      liftersBeforeYou,
      openerWeight,
      timeFormat,
      numWarmups,
      warmups,
      isRunning,
      activeWarmups: activeWarmups.map(w => ({
        ...w,
        targetTime: w.targetTime ? w.targetTime.getTime() : null,
        actualTime: w.actualTime ? w.actualTime.getTime() : null,
        completed: w.completed
      })),
      currentWarmupIndex,
      updatedAt: Date.now()
    };
    set(sessionRef, saveData);
  }

  // Load session from Firebase and subscribe to realtime updates
  function loadSession(sessionToLoad) {
    sessionId = sessionToLoad;
    const sessionRef = ref(db, "sessions/" + sessionId);
    onValue(sessionRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      flightStartTime = data.flightStartTime || "";
      liftersBeforeYou = data.liftersBeforeYou || 5;
      openerWeight = data.openerWeight || "";
      timeFormat = data.timeFormat || "24h";
      numWarmups = data.numWarmups || 3;
      warmups = data.warmups || [];
      isRunning = data.isRunning || false;
      currentWarmupIndex = data.currentWarmupIndex || 0;

      activeWarmups = (data.activeWarmups || []).map(w => ({
        ...w,
        targetTime: w.targetTime ? new Date(w.targetTime) : null,
        actualTime: w.actualTime ? new Date(w.actualTime) : null,
      }));

      renderApp();
    });
  }

  // Initialize warmups array with empty warmups
  function initWarmups(n) {
    warmups = [];
    for (let i = 0; i < n; i++) {
      warmups.push({
        weight: "",
        reps: 1,
        minutesBefore: 5,
        completed: false,
        targetTime: null,
        actualTime: null
      });
    }
  }

  // Render the app UI
  function renderApp() {
    // If running, show active timer UI, else setup UI
    if (isRunning) {
      renderTimer();
    } else {
      renderSetup();
    }
  }

  // Render setup UI
  function renderSetup() {
    appDiv.innerHTML = `
      <label>Flight Start Time:<br/>
        <input type="time" id="flightStart" value="${flightStartTime}" />
      </label><br/>

      <label>Lifters Before You:<br/>
        <input type="number" id="liftersBeforeYou" min="0" value="${liftersBeforeYou}" />
      </label><br/>

      <label>Opener Weight:<br/>
        <input type="text" id="openerWeight" value="${openerWeight}" placeholder="e.g. 180kg" />
      </label><br/>

      <label>Time Format:<br/>
        <select id="timeFormat">
          <option value="24h" ${timeFormat === "24h" ? "selected" : ""}>24-hour</option>
          <option value="12h" ${timeFormat === "12h" ? "selected" : ""}>12-hour</option>
        </select>
      </label><br/>

      <label>Number of Warmups:<br/>
        <select id="numWarmups">
          ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${n === numWarmups ? "selected" : ""}>${n}</option>`).join("")}
        </select>
      </label><br/>

      <div id="warmupsContainer"></div>

      <button id="startBtn" disabled>Start Timer</button>
      <button id="newSessionBtn">New Session</button>
    `;

    // Setup warmups inputs
    renderWarmupsInputs();

    // Enable start button only if flightStartTime and openerWeight are set
    document.getElementById("startBtn").disabled = !(flightStartTime && openerWeight.trim());

    // Add event listeners
    document.getElementById("flightStart").addEventListener("change", e => {
      flightStartTime = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("liftersBeforeYou").addEventListener("change", e => {
      liftersBeforeYou = Number(e.target.value);
      saveSession();
      renderApp();
    });
    document.getElementById("openerWeight").addEventListener("input", e => {
      openerWeight = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("timeFormat").addEventListener("change", e => {
      timeFormat = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("numWarmups").addEventListener("change", e => {
      const newNum = Number(e.target.value);
      if (newNum > warmups.length) {
        for(let i=warmups.length; i<newNum; i++) {
          warmups.push({
            weight: "",
            reps: 1,
            minutesBefore: 5,
            completed: false,
            targetTime: null,
            actualTime: null
          });
        }
      } else {
        warmups.splice(newNum);
      }
      numWarmups = newNum;
      saveSession();
      renderApp();
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      startTimer();
    });

    document.getElementById("newSessionBtn").addEventListener("click", () => {
      sessionId = generateSessionId();
      isRunning = false;
      activeWarmups = [];
      currentWarmupIndex = 0;
      initWarmups(numWarmups);
      saveSession();
      renderApp();
      window.history.replaceState(null, "", location.pathname + "?view=" + sessionId);
    });
  }

  // Render warmups input fields
  function renderWarmupsInputs() {
    const container = document.getElementById("warmupsContainer");
    container.innerHTML = "";

    warmups.forEach((w, i) => {
      const div = document.createElement("div");
      div.className = "warmup";
      div.draggable = true;
      div.dataset.index = i;

      div.innerHTML = `
        <label>Weight:
          <input type="text" class="weight" value="${w.weight}" placeholder="e.g. 135kg" />
        </label><br/>
        <label>Reps:
          <input type="number" class="reps" min="1" max="10" value="${w.reps}" />
        </label><br/>
        <label>Minutes Before:
          <input type="number" class="minutesBefore" min="1" max="60" value="${w.minutesBefore}" />
        </label>
      `;

      // Update warmups array on input change
      div.querySelector(".weight").addEventListener("input", e => {
        warmups[i].weight = e.target.value;
        saveSession();
      });
      div.querySelector(".reps").addEventListener("input", e => {
        warmups[i].reps = Number(e.target.value);
        saveSession();
      });
      div.querySelector(".minutesBefore").addEventListener("input", e => {
        warmups[i].minutesBefore = Number(e.target.value);
        saveSession();
      });

      // Drag and drop handlers for reorder
      div.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", i);
        div.classList.add("dragging");
      });
      div.addEventListener("dragend", e => {
        div.classList.remove("dragging");
      });
      div.addEventListener("dragover", e => {
        e.preventDefault();
        const draggingEl = document.querySelector(".dragging");
        if (!draggingEl) return;
        const fromIndex = Number(draggingEl.dataset.index);
        const toIndex = Number(div.dataset.index);
        if (fromIndex === toIndex) return;
        // reorder warmups array
        const moved = warmups.splice(fromIndex, 1)[0];
        warmups.splice(toIndex, 0, moved);
        saveSession();
        renderApp(); // re-render to update order
      });

      container.appendChild(div);
    });
  }

  // Start timer: calculate activeWarmups and begin countdown
  function startTimer() {
    const filledWarmups = warmups.filter(w => w.weight.trim() !== "");
    activeWarmups = calculateTargetTimes(filledWarmups);
    currentWarmupIndex = 0;
    isRunning = true;
    saveSession();
    renderApp();

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      renderApp();
    }, 1000);
  }

  // Complete current warmup and move to next
  function completeWarmup() {
    if (!isRunning) return;
    activeWarmups[currentWarmupIndex].completed = true;
    activeWarmups[currentWarmupIndex].actualTime = new Date();
    currentWarmupIndex++;
    if (currentWarmupIndex >= activeWarmups.length) {
      // Timer finished
      isRunning = false;
      clearInterval(timerInterval);
    }
    saveSession();
    renderApp();
  }

  // Render timer UI while running
  function renderTimer() {
    const warmupDivs = activeWarmups.map((w, i) => {
      const targetTime = w.targetTime;
      const now = new Date();
      const diff = targetTime ? targetTime.getTime() - now.getTime() : null;
      const minutes = diff !== null ? Math.floor(Math.abs(diff) / 60000) : "--";
      const seconds = diff !== null ? Math.floor((Math.abs(diff) % 60000) / 1000) : "--";
      const isLate = diff !== null && diff < 0;
      const isCurrent = i === currentWarmupIndex;

      return `
        <div style="
          background: ${w.completed ? "#2f855a" : isCurrent ? "#3182ce" : "#4a5568"};
          padding: 1rem;
          margin-bottom: 1rem;
          border-radius: 6px;
          color: white;
        ">
          <strong>Warmup ${i+1}:</strong> ${w.weight} x ${w.reps}<br/>
          ${w.minutesBefore} min before ${i === activeWarmups.length - 1 ? "opener" : "next warmup"}<br/>
          Target time: ${formatTime(targetTime)}<br/>
          ${w.completed ? "Completed at: " + formatTime(w.actualTime) : ""}
          ${isCurrent && !w.completed ? `
            <div style="margin-top: 0.5rem;">
              <button id="completeBtn">Complete Warmup</button>
              <div style="font-size: 2rem; color: ${isLate ? "red" : "green"}; margin-top: 0.5rem;">
                ${isLate ? "-" : ""}${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")} ${isLate ? "overdue" : "until target"}
              </div>
            </div>
          ` : ""}
        </div>
      `;
    }).join("");

    appDiv.innerHTML = `
      <h2>Timer Running</h2>
      ${warmupDivs}
      <div>
        <strong>Opener:</strong> ${openerWeight}
      </div>
      <button id="editBtn">Edit Timer</button>
    `;

    document.getElementById("completeBtn")?.addEventListener("click", completeWarmup);
    document.getElementById("editBtn").addEventListener("click", () => {
      isRunning = false;
      saveSession();
      renderApp();
      clearInterval(timerInterval);
    });
  }

  // Initialize or load session on page load
  function init() {
    const viewId = getViewSessionId();
    if (viewId) {
      sessionId = viewId;
      loadSession(sessionId);
    } else {
      sessionId = generateSessionId();
      initWarmups(numWarmups);
      saveSession();
      renderApp();
      window.history.replaceState(null, "", location.pathname + "?view=" + sessionId);
    }
  }

  // Start the app
  init();
</script>

</body>
</html>
