<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Powerlifting Warmup Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #1a202c;
      color: white;
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    input, select, button {
      margin: 0.5rem 0;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      background: #2d3748;
      color: white;
    }
    button {
      cursor: pointer;
      background: #48bb78;
      color: white;
      border: none;
    }
    button:disabled {
      background: #718096;
      cursor: not-allowed;
    }
    .warmup {
      background: #2d3748;
      padding: 0.5rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    .warmup > div {
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>
  <h1>Powerlifting Warmup Timer</h1>
  <div id="app">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAm9CzwFSHMmUQ7EUhp38OsnlUlLwXu75Q",
      authDomain: "powerliftingwarmuptimer.firebaseapp.com",
      databaseURL: "https://powerliftingwarmuptimer-default-rtdb.firebaseio.com/",
      projectId: "powerliftingwarmuptimer",
      storageBucket: "powerliftingwarmuptimer.firebasestorage.app",
      messagingSenderId: "209334487029",
      appId: "1:209334487029:web:8ffb1d4dd6c649e46f42bc",
      measurementId: "G-DHVVDB1SC5"
    };

    // Initialize Firebase and database
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM references
    const appDiv = document.getElementById("app");

    // Utility to get URL params
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Session ID from URL for sharing/view-only mode
    const sessionId = getParam("session") || null;
    const isViewOnly = sessionId !== null;

    // Default timer data
    let state = {
      flightStartTime: '',
      liftersBeforeYou: 5,
      totalLifters: 12,
      openerWeight: '',
      numWarmups: 3,
      timeFormat: '24h',
      warmups: [
        { weight: '', reps: 1, minutesBefore: 5, completed: false, actualTime: null },
        { weight: '', reps: 1, minutesBefore: 5, completed: false, actualTime: null },
        { weight: '', reps: 1, minutesBefore: 5, completed: false, actualTime: null },
      ],
      isRunning: false,
      currentWarmupIndex: 0,
      currentTime: Date.now()
    };

    // Update state in Firebase
    function saveState() {
      if (!sessionId) return;
      set(ref(db, 'sessions/' + sessionId), state).catch(console.error);
    }

    // Listen for realtime updates
    if (sessionId) {
      const sessionRef = ref(db, 'sessions/' + sessionId);
      onValue(sessionRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          state = data;
          render();
        }
      });
    }

    // Generate a random session ID (simple)
    function generateSessionId() {
      return Math.random().toString(36).substring(2, 10);
    }

    // Calculate opener time from flightStartTime + liftersBeforeYou
    function getOpenerTime() {
      if (!state.flightStartTime) return null;
      const [h, m] = state.flightStartTime.split(':').map(Number);
      const flightStart = new Date();
      flightStart.setHours(h, m, 0, 0);
      return new Date(flightStart.getTime() + state.liftersBeforeYou * 60000);
    }

    // Calculate warmup target times backward from opener
    function calculateTargetTimes() {
      if (!state.flightStartTime || state.warmups.length === 0) return;
      let nextTime = getOpenerTime();
      for (let i = state.warmups.length - 1; i >= 0; i--) {
        let w = state.warmups[i];
        w.targetTime = new Date(nextTime.getTime() - w.minutesBefore * 60000);
        nextTime = w.targetTime;
      }
    }

    // Format time string
    function formatTime(date) {
      if (!date) return '--:--';
      const options = { hour: '2-digit', minute: '2-digit', hour12: state.timeFormat === '12h' };
      return date.toLocaleTimeString([], options);
    }

    // Update current time every second
    setInterval(() => {
      state.currentTime = Date.now();
      render();
    }, 1000);

    // Render UI
    function render() {
      calculateTargetTimes();

      appDiv.innerHTML = '';

      // Share link if no session
      if (!sessionId) {
        const startSessionBtn = document.createElement('button');
        startSessionBtn.textContent = 'Start New Shared Timer';
        startSessionBtn.onclick = () => {
          const newId = generateSessionId();
          window.history.replaceState(null, null, `?session=${newId}`);
          state.isRunning = false;
          state.currentWarmupIndex = 0;
          saveState();
          render();
        };
        appDiv.appendChild(startSessionBtn);
        appDiv.appendChild(document.createElement('hr'));
      }

      // Form fields (disabled if view only)
      const createInput = (labelText, value, onChange, type = "text", disabled = false) => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = labelText;
        const input = document.createElement('input');
        input.type = type;
        input.value = value;
        input.disabled = disabled;
        input.oninput = e => {
          onChange(e.target.value);
          if (sessionId) saveState();
        };
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        return wrapper;
      };

      // Time Format select
      const createSelect = (labelText, value, options, onChange, disabled = false) => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = labelText;
        const select = document.createElement('select');
        select.disabled = disabled;
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if (opt.value === value) option.selected = true;
          select.appendChild(option);
        });
        select.onchange = e => {
          onChange(e.target.value);
          if (sessionId) saveState();
        };
        wrapper.appendChild(label);
        wrapper.appendChild(select);
        return wrapper;
      };

      appDiv.appendChild(createInput('Flight Start Time (HH:MM)', state.flightStartTime, v => state.flightStartTime = v, 'time', isViewOnly));
      appDiv.appendChild(createInput('Lifters Before You', state.liftersBeforeYou, v => state.liftersBeforeYou = Number(v), 'number', isViewOnly));
      appDiv.appendChild(createInput('Total Lifters in Flight', state.totalLifters || 12, v => state.totalLifters = Number(v), 'number', isViewOnly));
      appDiv.appendChild(createSelect('Time Format', state.timeFormat, [
        { value: '24h', label: '24-hour (14:30)' },
        { value: '12h', label: '12-hour (2:30 PM)' }
      ], v => state.timeFormat = v, isViewOnly));

      // Warmups inputs
      const warmupsDiv = document.createElement('div');
      warmupsDiv.innerHTML = '<h3>Warmups</h3>';

      state.warmups.forEach((w, i) => {
        const warmupDiv = document.createElement('div');
        warmupDiv.className = 'warmup';

        // Weight
        warmupDiv.appendChild(createInput(`Warmup ${i+1} Weight (kg)`, w.weight, v => {
          state.warmups[i].weight = v;
          if (sessionId) saveState();
        }, 'text', isViewOnly));

        // Reps
        warmupDiv.appendChild(createInput(`Warmup ${i+1} Reps`, w.reps, v => {
          state.warmups[i].reps = Number(v);
          if (sessionId) saveState();
        }, 'number', isViewOnly));

        // Minutes before
        warmupDiv.appendChild(createInput(`Minutes Before Next Warmup`, w.minutesBefore, v => {
          state.warmups[i].minutesBefore = Number(v);
          if (sessionId) saveState();
        }, 'number', isViewOnly));

        // Target Time display
        const targetP = document.createElement('p');
        targetP.textContent = 'Target Time: ' + formatTime(w.targetTime);
        warmupDiv.appendChild(targetP);

        // Completed checkbox if not view only
        if (!isViewOnly) {
          const completeBtn = document.createElement('button');
          completeBtn.textContent = w.completed ? 'Completed âœ“' : 'Mark Completed';
          completeBtn.disabled = w.completed || !state.isRunning;
          completeBtn.onclick = () => {
            if (!w.completed) {
              state.warmups[i].completed = true;
              state.warmups[i].actualTime = new Date().toISOString();
              if (sessionId) saveState();
              render();
            }
          };
          warmupDiv.appendChild(completeBtn);
        }

        warmupsDiv.appendChild(warmupDiv);
      });

      appDiv.appendChild(warmupsDiv);

      // Opener Weight
      appDiv.appendChild(createInput('Opener Weight', state.openerWeight, v => {
        state.openerWeight = v;
        if (sessionId) saveState();
      }, 'text', isViewOnly));

      // Start / Reset buttons
      const btnDiv = document.createElement('div');

      const canStart = state.flightStartTime && state.openerWeight && state.warmups.some(w => w.weight.trim() !== '');
      const startBtn = document.createElement('button');
      startBtn.textContent = state.isRunning ? 'Running...' : 'Start Timer';
      startBtn.disabled = !canStart || state.isRunning || isViewOnly;
      startBtn.onclick = () => {
        state.isRunning = true;
        state.currentWarmupIndex = 0;
        if (sessionId) saveState();
        render();
      };
      btnDiv.appendChild(startBtn);

      const resetBtn = document.createElement('button');
      resetBtn.textContent = 'Reset Timer';
      resetBtn.onclick = () => {
        state.isRunning = false;
        state.currentWarmupIndex = 0;
        state.warmups.forEach(w => { w.completed = false; w.actualTime = null; });
        if (sessionId) saveState();
        render();
      };
      btnDiv.appendChild(resetBtn);

      appDiv.appendChild(btnDiv);

      // Show share link if not view only
      if (!sessionId) {
        const linkP = document.createElement('p');
        linkP.style.marginTop = '1rem';
        const newSessionId = generateSessionId();
        linkP.innerHTML = `Share this link to sync timer live:<br><input type="text" readonly style="width: 100%" value="${window.location.origin + window.location.pathname}?session=${newSessionId}">`;
        appDiv.appendChild(linkP);
      }
    }

    render();
  </script>
</body>
</html>
