<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAm9CzwFSHMmUQ7EUhp38OsnlUlLwXu75Q",
    authDomain: "powerliftingwarmuptimer.firebaseapp.com",
    databaseURL: "https://powerliftingwarmuptimer-default-rtdb.firebaseio.com/",
    projectId: "powerliftingwarmuptimer",
    storageBucket: "powerliftingwarmuptimer.firebasestorage.app",
    messagingSenderId: "209334487029",
    appId: "1:209334487029:web:8ffb1d4dd6c649e46f42bc",
    measurementId: "G-DHVVDB1SC5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function getViewSessionId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("view");
  }

  let flightStartTime = "";
  let liftersBeforeYou = 5;
  let openerWeight = "";
  let timeFormat = "24h";
  let numWarmups = 3;
  let warmups = [];
  let isRunning = false;
  let activeWarmups = [];
  let currentWarmupIndex = 0;
  let timerInterval = null;
  let sessionId = "";
  const appDiv = document.getElementById("app");

  function formatTime(date) {
    if (!date) return "--:--";
    const hour12 = timeFormat === "12h";
    return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12 });
  }

  function calculateTargetTimes(warmupsToCalc) {
    if (!flightStartTime || warmupsToCalc.length === 0) return warmupsToCalc;
    const [hours, minutes] = flightStartTime.split(":").map(Number);
    const flightStart = new Date();
    flightStart.setHours(hours, minutes, 0, 0);
    const openerTime = new Date(flightStart.getTime() + liftersBeforeYou * 60000);
    const result = [...warmupsToCalc];
    let nextTime = openerTime;
    for (let i = result.length - 1; i >= 0; i--) {
      const targetTime = new Date(nextTime.getTime() - result[i].minutesBefore * 60000);
      result[i].targetTime = targetTime;
      nextTime = targetTime;
    }
    return result;
  }

  function generateSessionId() {
    return Math.random().toString(36).slice(2, 10);
  }

  function saveSession() {
    if (!sessionId) return;
    const sessionRef = ref(db, "sessions/" + sessionId);
    const saveData = {
      flightStartTime,
      liftersBeforeYou,
      openerWeight,
      timeFormat,
      numWarmups,
      warmups,
      isRunning,
      activeWarmups: activeWarmups.map(w => ({
        ...w,
        targetTime: w.targetTime ? w.targetTime.getTime() : null,
        actualTime: w.actualTime ? w.actualTime.getTime() : null,
        completed: w.completed
      })),
      currentWarmupIndex,
      updatedAt: Date.now()
    };
    set(sessionRef, saveData);
  }

  function loadSession(sessionToLoad) {
    sessionId = sessionToLoad;
    const sessionRef = ref(db, "sessions/" + sessionId);
    onValue(sessionRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      flightStartTime = data.flightStartTime || "";
      liftersBeforeYou = data.liftersBeforeYou || 5;
      openerWeight = data.openerWeight || "";
      timeFormat = data.timeFormat || "24h";
      numWarmups = data.numWarmups || 3;
      warmups = data.warmups || [];
      isRunning = data.isRunning || false;
      currentWarmupIndex = data.currentWarmupIndex || 0;

      activeWarmups = (data.activeWarmups || []).map(w => ({
        ...w,
        targetTime: w.targetTime ? new Date(w.targetTime) : null,
        actualTime: w.actualTime ? new Date(w.actualTime) : null,
      }));

      renderApp();
    });
  }

  function initWarmups(n) {
    warmups = [];
    for (let i = 0; i < n; i++) {
      warmups.push({
        weight: "",
        reps: 1,
        minutesBefore: 5,
        completed: false,
        targetTime: null,
        actualTime: null
      });
    }
  }

  function renderApp() {
    if (timerInterval) clearInterval(timerInterval); // Clear any existing interval

    if (isRunning) {
      renderTimer();
      // Start interval to update UI every second for everyone (including viewers)
      timerInterval = setInterval(() => {
        renderTimer();
      }, 1000);
    } else {
      renderSetup();
    }
  }

  function renderSetup() {
    appDiv.innerHTML = `
      <label>Flight Start Time:<br/>
        <input type="time" id="flightStart" value="${flightStartTime}" />
      </label><br/>

      <label>Lifters Before You:<br/>
        <input type="number" id="liftersBeforeYou" min="0" value="${liftersBeforeYou}" />
      </label><br/>

      <label>Opener Weight:<br/>
        <input type="text" id="openerWeight" value="${openerWeight}" placeholder="e.g. 180kg" />
      </label><br/>

      <label>Time Format:<br/>
        <select id="timeFormat">
          <option value="24h" ${timeFormat === "24h" ? "selected" : ""}>24-hour</option>
          <option value="12h" ${timeFormat === "12h" ? "selected" : ""}>12-hour</option>
        </select>
      </label><br/>

      <label>Number of Warmups:<br/>
        <select id="numWarmups">
          ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${n === numWarmups ? "selected" : ""}>${n}</option>`).join("")}
        </select>
      </label><br/>

      <div id="warmupsContainer"></div>

      <button id="startBtn" disabled>Start Timer</button>
      <button id="newSessionBtn">New Session</button>
    `;

    renderWarmupsInputs();

    document.getElementById("startBtn").disabled = !(flightStartTime && openerWeight.trim());

    document.getElementById("flightStart").addEventListener("change", e => {
      flightStartTime = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("liftersBeforeYou").addEventListener("change", e => {
      liftersBeforeYou = Number(e.target.value);
      saveSession();
      renderApp();
    });
    document.getElementById("openerWeight").addEventListener("input", e => {
      openerWeight = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("timeFormat").addEventListener("change", e => {
      timeFormat = e.target.value;
      saveSession();
      renderApp();
    });
    document.getElementById("numWarmups").addEventListener("change", e => {
      const newNum = Number(e.target.value);
      if (newNum > warmups.length) {
        for(let i=warmups.length; i<newNum; i++) {
          warmups.push({
            weight: "",
            reps: 1,
            minutesBefore: 5,
            completed: false,
            targetTime: null,
            actualTime: null
          });
        }
      } else {
        warmups.splice(newNum);
      }
      numWarmups = newNum;
      saveSession();
      renderApp();
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      startTimer();
    });

    document.getElementById("newSessionBtn").addEventListener("click", () => {
      sessionId = generateSessionId();
      isRunning = false;
      activeWarmups = [];
      currentWarmupIndex = 0;
      initWarmups(numWarmups);
      saveSession();
      renderApp();
      window.history.replaceState(null, "", location.pathname + "?view=" + sessionId);
    });
  }

  function renderWarmupsInputs() {
    const container = document.getElementById("warmupsContainer");
    container.innerHTML = "";

    warmups.forEach((w, i) => {
      const div = document.createElement("div");
      div.className = "warmup";
      div.draggable = true;
      div.dataset.index = i;

      div.innerHTML = `
        <label>Weight:
          <input type="text" class="weight" value="${w.weight}" placeholder="e.g. 135kg" />
        </label><br/>
        <label>Reps:
          <input type="number" class="reps" min="1" max="10" value="${w.reps}" />
        </label><br/>
        <label>Minutes Before:
          <input type="number" class="minutesBefore" min="1" max="60" value="${w.minutesBefore}" />
        </label>
      `;

      div.querySelector(".weight").addEventListener("input", e => {
        warmups[i].weight = e.target.value;
        saveSession();
      });
      div.querySelector(".reps").addEventListener("input", e => {
        warmups[i].reps = Number(e.target.value);
        saveSession();
      });
      div.querySelector(".minutesBefore").addEventListener("input", e => {
        warmups[i].minutesBefore = Number(e.target.value);
        saveSession();
      });

      div.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", i);
        div.classList.add("dragging");
      });
      div.addEventListener("dragend", e => {
        div.classList.remove("dragging");
      });
      div.addEventListener("dragover", e => {
        e.preventDefault();
        const draggingEl = document.querySelector(".dragging");
        if (!draggingEl) return;
        const fromIndex = Number(draggingEl.dataset.index);
        const toIndex = Number(div.dataset.index);
        if (fromIndex === toIndex) return;
        const moved = warmups.splice(fromIndex, 1)[0];
        warmups.splice(toIndex, 0, moved);
        saveSession();
        renderApp();
      });

      container.appendChild(div);
    });
  }

  function startTimer() {
    const filledWarmups = warmups.filter(w => w.weight.trim() !== "");
    activeWarmups = calculateTargetTimes(filledWarmups);
    currentWarmupIndex = 0;
    isRunning = true;
    saveSession();
    renderApp();

    // timerInterval is set in renderApp() for both owner and viewers
  }

  function completeWarmup() {
    if (!isRunning) return;
    activeWarmups[currentWarmupIndex].completed = true;
    activeWarmups[currentWarmupIndex].actualTime = new Date();
    curren
